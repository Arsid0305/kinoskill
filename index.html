<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        // ==========================================
        // üîë –ù–ê–°–¢–†–û–ô–ö–ò (–í–°–¢–ê–í–¨ –°–í–û–ò –î–ê–ù–ù–´–ï)
        // ==========================================
        
        // 1. DEEPSEEK KEY
        const ds_part1 = "sk-2b68062a5a8d"; 
        const ds_part2 = "4ae1bad063ddaced8f7a";
        const DEEPSEEK_KEY = ds_part1 + ds_part2;

        // 2. SUPABASE URL (Project URL)
        const SUPABASE_URL = "https://evwuyatvrsxsqfdwufnk.supabase.co"; 
        
        // 3. SUPABASE KEY (Anon Public)
        const SUPABASE_KEY = "sb_publishable_Y2P06hbswDxhbaRJNxMVKg_IMTvcg6h";
        
        // ==========================================

        // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ë–ê–ó–´ –î–ê–ù–ù–´–• ---
        let sbClient = null; // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥—Ä—É–≥–æ–µ –∏–º—è –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π, —á—Ç–æ–±—ã –Ω–µ –ª–æ–º–∞—Ç—å —Å–∫—Ä–∏–ø—Ç
        
        try {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤—Å—Ç–∞–≤–ª–µ–Ω—ã –ª–∏ –∫–ª—é—á–∏, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –æ—à–∏–±–∫–∏
            if (SUPABASE_URL.includes("https") && !SUPABASE_KEY.includes("–í–°–¢–ê–í–¨")) {
                if (typeof supabase !== 'undefined') {
                    sbClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                }
            } else {
                console.log("Supabase –∫–ª—é—á–∏ –Ω–µ –≤—Å—Ç–∞–≤–ª–µ–Ω—ã, —Ä–∞–±–æ—Ç–∞–µ–º –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º —Ä–µ–∂–∏–º–µ.");
            }
        } catch(e) {
            console.error("–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Supabase:", e);
        }

        let currentMode = 'local';
        let db = [];
        let filters = {};
        let currentSuggestion = null;
        let userHistory = {}; 
        
        // ID –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        let userId = localStorage.getItem('kino_user_id');
        if (!userId) {
            userId = 'user_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('kino_user_id', userId);
        }

        // --- –ó–ê–ì–†–£–ó–ö–ê –ò–°–¢–û–†–ò–ò ---
        async function loadHistory() {
            if (!sbClient) return; // –ï—Å–ª–∏ –±–∞–∑—ã –Ω–µ—Ç, –ø—Ä–æ—Å—Ç–æ –≤—ã—Ö–æ–¥–∏–º
            
            const { data, error } = await sbClient
                .from('ratings')
                .select('*')
                .eq('user_id', userId);

            if (data) {
                userHistory = {};
                data.forEach(item => {
                    userHistory[item.movie] = item.score;
                });
                console.log("–ò—Å—Ç–æ—Ä–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–∞:", userHistory);
                // –ó–µ–ª–µ–Ω—ã–π –ª–æ–≥–æ—Ç–∏–ø = –±–∞–∑–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç
                document.querySelector('.logo').style.color = "#4cd964"; 
            }
        }
        
        loadHistory();

        // --- –§–£–ù–ö–¶–ò–ò –ò–ù–¢–ï–†–§–ï–ô–°–ê (–ö–ù–û–ü–ö–ò) ---
        function setMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.mode-option').forEach(el => {
                el.classList.remove('active-local', 'active-ai');
            });
            const btn = document.getElementById('mainBtn');
            if (mode === 'local') {
                document.getElementById('modeLocal').classList.add('active-local');
                btn.className = 'main-action-btn btn-theme-local';
                btn.innerHTML = '<span>üé≤ –ü–û–î–û–ë–†–ê–¢–¨ –ò–ó –°–ü–ò–°–ö–ê</span>';
            } else {
                document.getElementById('modeAI').classList.add('active-ai');
                btn.className = 'main-action-btn btn-theme-ai';
                btn.innerHTML = '<span>üê≥ –ò–ò –ü–†–ï–î–°–ö–ê–ó–ê–ù–ò–ï</span>';
            }
        }

        function toggle(btn, val) {
            const group = btn.parentElement.dataset.group;
            
            // –ï—Å–ª–∏ –∫–Ω–æ–ø–∫–∞ —É–∂–µ –≤—ã–±—Ä–∞–Ω–∞ ‚Äî —Å–Ω–∏–º–∞–µ–º –≤—ã–±–æ—Ä
            if (btn.classList.contains('selected')) {
                btn.classList.remove('selected');
                delete filters[group];
                return;
            }
            
            // –°–Ω–∏–º–∞–µ–º –≤—ã–±–æ—Ä —Å —Å–æ—Å–µ–¥–µ–π
            btn.parentElement.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('selected'));
            
            // –í—ã–±–∏—Ä–∞–µ–º —Ç–µ–∫—É—â—É—é
            btn.classList.add('selected');
            filters[group] = val;
        }

        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    db = XLSX.utils.sheet_to_json(firstSheet);
                    if (db.length > 0) {
                        document.getElementById('statusDot').classList.add('ready');
                        document.getElementById('statusText').innerText = `–§–∞–π–ª–æ–≤: ${db.length}`;
                    }
                } catch (err) { alert("–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è Excel."); }
            };
            reader.readAsArrayBuffer(file);
        });

        // --- –ì–õ–ê–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø ---
        async function run() {
            if (db.length === 0 && currentMode === 'local') return alert("–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª!");
            
            const modal = document.getElementById('modal');
            const overlay = document.getElementById('overlay');
            const btn = document.getElementById('mainBtn');
            const originalBtnText = btn.innerHTML;
            
            // –°–±—Ä–æ—Å –∑–≤–µ–∑–¥
            document.querySelectorAll('.rate-btn').forEach(b => b.classList.remove('active'));
            currentSuggestion = null; 

            btn.innerHTML = '<div class="loader"></div>';

            try {
                if (currentMode === 'local') {
                    runLocalLogic();
                } else {
                    if (DEEPSEEK_KEY.includes("–í–°–¢–ê–í–¨")) throw new Error("–ö–ª—é—á DeepSeek –Ω–µ –≤—Å—Ç–∞–≤–ª–µ–Ω!");
                    await runDeepSeekLogic();
                }
                overlay.classList.add('active');
                modal.classList.add('active');
            } catch (error) {
                alert(error.message);
            } finally {
                btn.innerHTML = originalBtnText;
            }
        }

        function runLocalLogic() {
            let filtered = db.filter(movie => {
                const rowStr = JSON.stringify(movie).toLowerCase();
                if (filters.genre && !rowStr.includes(filters.genre.toLowerCase())) return false;
                if (filters.type && !rowStr.includes(filters.type.toLowerCase())) return false;
                return true;
            });
            if (filtered.length === 0) filtered = db;
            
            const randomMovie = filtered[Math.floor(Math.random() * filtered.length)];
            const keys = Object.keys(randomMovie);
            const titleKey = keys.find(k => k.match(/–Ω–∞–∑–≤–∞–Ω–∏–µ|title|name/i)) || keys[0];
            const infoKey = keys.find(k => k.match(/–≥–æ–¥|year|–∂–∞–Ω—Ä|genre/i)) || keys[1];
            
            currentSuggestion = randomMovie[titleKey];

            displayResult(
                "–õ–û–ö–ê–õ–¨–ù–´–ô –ü–û–î–ë–û–†",
                currentSuggestion,
                randomMovie[infoKey] || "–ò–∑ —Å–ø–∏—Å–∫–∞",
                "–°–ª—É—á–∞–π–Ω—ã–π –≤—ã–±–æ—Ä –ø–æ –≤–∞—à–∏–º —Ñ–∏–ª—å—Ç—Ä–∞–º."
            );
        }

        async function runDeepSeekLogic() {
            const filterText = Object.entries(filters).map(([k, v]) => `${k}: ${v}`).join(", ") || "–Ω–∞ —Ç–≤–æ–π –≤–∫—É—Å";
            
            // –ò—Å—Ç–æ—Ä–∏—è
            const likes = Object.keys(userHistory).filter(k => userHistory[k] === 'like').join(", ");
            const dislikes = Object.keys(userHistory).filter(k => userHistory[k] === 'dislike').join(", ");
            
            let memoryContext = "";
            if (likes) memoryContext += `–†–∞–Ω–µ–µ –º–Ω–µ –û–ß–ï–ù–¨ –ø–æ–Ω—Ä–∞–≤–∏–ª–∏—Å—å: [${likes}]. –ü—Ä–µ–¥–ª–∞–≥–∞–π –ø–æ—Ö–æ–∂–µ–µ. `;
            if (dislikes) memoryContext += `–ú–Ω–µ –ù–ï –ø–æ–Ω—Ä–∞–≤–∏–ª–∏—Å—å: [${dislikes}]. –ò–∑–±–µ–≥–∞–π —Ç–∞–∫–æ–≥–æ. `;

            // –ö–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ —Ñ–∞–π–ª–∞
            const sample = db.sort(() => 0.5 - Math.random()).slice(0, 10).map(m => Object.values(m)[0]).join(", ");

            const prompt = `
                –¢—ã —ç–∫—Å–ø–µ—Ä—Ç. –Ø –∏—â—É —Ñ–∏–ª—å–º.
                –ú–æ–∏ —É—Å–ª–æ–≤–∏—è —Å–µ–π—á–∞—Å: ${filterText}.
                –ú–û–Ø –ò–°–¢–û–†–ò–Ø (–£–ß–ò–¢–´–í–ê–ô): ${memoryContext}
                –ß—Ç–æ —è —É–∂–µ –≤–∏–¥–µ–ª: [${sample}].
                –ü—Ä–µ–¥–ª–æ–∂–∏ 1 —Ñ–∏–ª—å–º. –í–µ—Ä–Ω–∏ JSON:
                { "title": "–ù–∞–∑–≤–∞–Ω–∏–µ", "info": "–ì–æ–¥, –ñ–∞–Ω—Ä", "reason": "–ü–æ—á–µ–º—É —ç—Ç–æ –ø–æ–¥—Ö–æ–¥–∏—Ç –º–Ω–µ." }
            `;

            const response = await fetch("https://api.deepseek.com/chat/completions", {
                method: "POST",
                headers: { "Content-Type": "application/json", "Authorization": `Bearer ${DEEPSEEK_KEY}` },
                body: JSON.stringify({
                    model: "deepseek-chat",
                    messages: [
                        { role: "system", content: "You are a movie recommender. Output strictly JSON." },
                        { role: "user", content: prompt }
                    ],
                    response_format: { type: "json_object" }
                })
            });

            if (!response.ok) {
                 const errData = await response.json();
                 throw new Error("DeepSeek –æ—à–∏–±–∫–∞: " + (errData.error?.message || response.status));
            }
            const data = await response.json();
            const content = JSON.parse(data.choices[0].message.content);
            
            currentSuggestion = content.title;
            displayResult("AI –ü–†–û–ì–ù–û–ó", content.title, content.info, content.reason);
        }

        function displayResult(tag, title, info, reason) {
            document.getElementById('resTag').innerText = tag;
            document.getElementById('resTitle').innerText = title;
            document.getElementById('resInfo').innerText = info;
            document.getElementById('resReason').innerText = reason;
        }

        function closeModal() {
            document.getElementById('overlay').classList.remove('active');
            document.getElementById('modal').classList.remove('active');
        }

        // --- –û–¶–ï–ù–ö–ê ---
        async function rate(btn) {
            // –í–∏–∑—É–∞–ª
            document.querySelectorAll('.rate-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            if (!currentSuggestion) return;

            const ratingType = btn.getAttribute('data-rate');
            let scoreValue = 'neutral';
            if (ratingType === 'like' || ratingType === 'super') scoreValue = 'like';
            if (ratingType === 'dislike') scoreValue = 'dislike';
            
            // 1. –õ–æ–∫–∞–ª—å–Ω–æ
            userHistory[currentSuggestion] = scoreValue;

            // 2. –í –û–±–ª–∞–∫–æ
            if (sbClient) {
                const { error } = await sbClient
                    .from('ratings')
                    .insert([
                        { user_id: userId, movie: currentSuggestion, score: scoreValue }
                    ]);
                if (error) console.error(error);
                else console.log("Saved to Supabase");
            }
        }
        
        // –°–ï–ö–†–ï–¢ (5 –∫–ª–∏–∫–æ–≤ –ø–æ –ª–æ–≥–æ)
        let debugClicks = 0;
        function showDebugHistory() {
            debugClicks++;
            if (debugClicks === 5) {
                const count = Object.keys(userHistory).length;
                const status = sbClient ? "‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ" : "‚ùå –ù–µ—Ç —Å–≤—è–∑–∏";
                alert(`ID: ${userId}\n–ë–∞–∑–∞: ${status}\n–û—Ü–µ–Ω–æ–∫: ${count}`);
                debugClicks = 0;
            }
        }
    </script>
