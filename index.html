<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>–ö–ò–ù–û –°–∫–∏–ª–ª 2.0</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        :root { --bg: #0f1014; --card: #1e1e24; --btn: #2b2b30; --accent: #bb86fc; --ai: #03dac6; --text: #fff; --dim: #9aa0a6; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); padding: 20px; padding-bottom: 160px; margin: 0; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .logo { font-size: 1.5rem; font-weight: 800; }
        .switch { display: flex; background: #222; border-radius: 12px; padding: 4px; margin-bottom: 25px; border: 1px solid #333; }
        .sw-btn { flex: 1; padding: 12px; text-align: center; border-radius: 10px; font-weight: 600; color: #666; transition: 0.3s; cursor: pointer; }
        .sw-btn.active { color: #000; background: #fff; }
        .sw-btn.ai-active { background: var(--ai); color: #000; box-shadow: 0 0 15px rgba(3,218,198,0.3); }
        .title { font-size: 0.7rem; color: var(--dim); text-transform: uppercase; margin: 25px 0 10px 5px; font-weight: 600; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; }
        .btn { background: var(--btn); border: 1px solid transparent; color: var(--text); padding: 14px; border-radius: 16px; font-size: 0.85rem; text-align: center; min-height: 48px; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .btn.active { border-color: #fff; background: #383840; }
        .main-btn { position: fixed; bottom: 40px; left: 20px; right: 20px; background: #fff; color: #000; border: none; padding: 20px; border-radius: 24px; font-weight: 800; font-size: 1.1rem; z-index: 100; box-shadow: 0 10px 40px rgba(0,0,0,0.5); text-transform: uppercase; cursor: pointer; }
        .ai-btn { background: linear-gradient(135deg, #03dac6, #018786) !important; color: #000 !important; }
        #popup { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 85%; background: var(--card); padding: 30px; border-radius: 35px; z-index: 1000; border: 1px solid #333; text-align: center; }
        .ovl { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 999; backdrop-filter: blur(5px); }
        .loader { display: inline-block; width: 18px; height: 18px; border: 3px solid rgba(0,0,0,0.2); border-top-color: #000; border-radius: 50%; animation: spin 1s infinite; vertical-align: middle; margin-right: 8px; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div class="header">
        <div class="logo">–ö–ò–ù–û –°–∫–∏–ª–ª 2.0</div>
        <div style="font-size: 0.7rem; color: var(--dim);" id="status">–ó–∞–≥—Ä—É–∑–∏—Ç–µ Excel</div>
    </div>

    <div class="switch">
        <div id="btnLocal" class="sw-btn active" onclick="setMode('local')">üìÇ –ú–æ–∏ —Ñ–∏–ª—å–º—ã</div>
        <div id="btnAI" class="sw-btn" onclick="setMode('ai')">‚ú® Gemini 2.0</div>
    </div>

    <input type="file" id="fileInput" accept=".xlsx, .xls, .csv">

    <div class="title">–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ</div>
    <div class="grid" data-g="mood">
        <button class="btn" onclick="sel(this, '–í–µ—Å—ë–ª–æ–µ')">üòä –í–µ—Å—ë–ª–æ–µ</button>
        <button class="btn" onclick="sel(this, '–ó–∞–¥—É–º—á–∏–≤–æ–µ')">ü§î –î—É–º–∞—Ç—å</button>
        <button class="btn" onclick="sel(this, '–°–ø–æ–∫–æ–π–Ω–æ–µ')">üòå –†–µ–ª–∞–∫—Å</button>
    </div>

    <div class="title">–ñ–∞–Ω—Ä (–∏–∑ —Ñ–∞–π–ª–∞)</div>
    <div id="genreGrid" class="grid" data-g="genre"><div style="font-size:0.8rem; opacity:0.5; padding:10px;">–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª...</div></div>

    <button id="mainBtn" class="main-btn" onclick="go()">–ü–û–î–û–ë–†–ê–¢–¨</button>

    <div class="ovl" id="overlay" onclick="closePopup()"></div>
    <div id="popup">
        <h2 id="resTitle" style="margin:0 0 10px; font-size:1.6rem;"></h2>
        <p id="resInfo" style="color:var(--dim); font-size:0.9rem; margin-bottom:20px;"></p>
        <div id="resReason" style="font-size:0.9rem; background:#2b2b30; padding:15px; border-radius:20px; color:#ddd; text-align:left;"></div>
        <button onclick="closePopup()" style="width:100%; padding:18px; margin-top:25px; border-radius:20px; background:#fff; border:none; font-weight:bold; cursor:pointer;">–ö–†–£–¢–û</button>
    </div>

    <script>
        // --- –ó–ê–©–ò–¢–ê –û–¢ –°–ö–ê–ù–ï–†–û–í GITHUB ---
        const part1 = "–í–°–¢–ê–í–¨_–ü–ï–†–í–£–Æ_–ß–ê–°–¢–¨"; 
        const part2 = "–í–°–¢–ê–í–¨_–í–¢–û–†–£–Æ_–ß–ê–°–¢–¨";
        // ---------------------------------
        const API_KEY = part1 + part2;

        let mode = 'local';
        let db = [];
        let picks = {};
        let cols = { t: null, g: null };

        function setMode(m) {
            mode = m;
            document.getElementById('btnLocal').className = `sw-btn ${m==='local'?'active':''}`;
            document.getElementById('btnAI').className = `sw-btn ${m==='ai'?'ai-active':''}`;
            document.getElementById('mainBtn').innerText = (m === 'ai') ? "‚ú® –°–ü–†–û–°–ò–¢–¨ GEMINI" : "–ü–û–î–û–ë–†–ê–¢–¨";
        }

        function sel(el, val) {
            const grp = el.parentElement.dataset.g;
            el.parentElement.querySelectorAll('.btn').forEach(b => b.classList.remove('active'));
            el.classList.add('active'); picks[grp] = val;
        }

        document.getElementById('fileInput').addEventListener('change', function(e) {
            const r = new FileReader();
            r.onload = (ev) => {
                const d = new Uint8Array(ev.target.result);
                const wb = XLSX.read(d, {type:'array'});
                const sheet = wb.Sheets[wb.SheetNames[0]];
                const json = XLSX.utils.sheet_to_json(sheet);
                const k = Object.keys(json[0]);
                cols.t = k.find(x=>/–Ω–∞–∑–≤–∞–Ω–∏–µ|title/i.test(x)) || k[0];
                cols.g = k.find(x=>/–∂–∞–Ω—Ä|genre/i.test(x));
                db = json;
                document.getElementById('status').innerText = `‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ: ${db.length}`;
                if(cols.g) {
                    const set = new Set();
                    db.forEach(r => { if(r[cols.g]) r[cols.g].toString().split(',').forEach(s=>set.add(s.trim())); });
                    const box = document.getElementById('genreGrid'); box.innerHTML = '';
                    [...set].sort().slice(0,12).forEach(g => {
                        const b = document.createElement('button');
                        b.className = 'btn'; b.innerText = g; b.onclick = () => sel(b, g); box.appendChild(b);
                    });
                }
            };
            r.readAsArrayBuffer(e.target.files[0]);
        });

        async function go() {
            if(mode === 'local') {
                if(!db.length) return alert("–ó–∞–≥—Ä—É–∑–∏ —Ñ–∞–π–ª!");
                const m = db[Math.floor(Math.random()*db.length)];
                show(m[cols.t], m[cols.g] || "", "–°–ª—É—á–∞–π–Ω—ã–π –≤—ã–±–æ—Ä.");
            } else {
                const btn = document.getElementById('mainBtn');
                const oldTxt = btn.innerText;
                btn.innerHTML = '<div class="loader"></div> –î–£–ú–ê–Æ...';

                // –ü—Ä–æ–º–ø—Ç –¥–ª—è –º–æ–¥–µ–ª–∏
                const promptText = `–ü–æ—Å–æ–≤–µ—Ç—É–π 1 —Ñ–∏–ª—å–º. –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ: ${picks.mood || '–ª—é–±–æ–µ'}. –ñ–∞–Ω—Ä: ${picks.genre || '–ª—é–±–æ–π'}. –û—Ç–≤–µ—Ç JSON: {"title":"–ù–∞–∑–≤–∞–Ω–∏–µ","info":"–ì–æ–¥, –ñ–∞–Ω—Ä","reason":"–ü–æ—á–µ–º—É"}`;

                try {
                    // 1. –ò–°–ü–û–õ–¨–ó–£–ï–ú GEMINI 2.0 FLASH (—Å–∞–º–∞—è –∞–∫—Ç—É–∞–ª—å–Ω–∞—è)
                    const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${API_KEY}`;
                    
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: promptText }] }],
                            // 2. –ñ–ï–°–¢–ö–û –¢–†–ï–ë–£–ï–ú JSON (—á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ undefined –æ—à–∏–±–æ–∫)
                            generationConfig: {
                                responseMimeType: "application/json"
                            }
                        })
                    });

                    const data = await response.json();
                    
                    // –õ–æ–≤–∏–º –æ—à–∏–±–∫—É –æ—Ç Google
                    if (data.error) {
                        console.error("Gemini Error:", data.error);
                        throw new Error(data.error.message);
                    }
                    
                    // 3. –ë–ï–ó–û–ü–ê–°–ù–ê–Ø –û–ë–†–ê–ë–û–¢–ö–ê –û–¢–í–ï–¢–ê
                    if (!data.candidates || !data.candidates[0].content.parts[0].text) {
                        throw new Error("–ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –æ—Ç –ò–ò.");
                    }

                    const raw = data.candidates[0].content.parts[0].text;
                    const res = JSON.parse(raw); // –¢–µ–ø–µ—Ä—å —Ç—É—Ç –≤—Å–µ–≥–¥–∞ —á–∏—Å—Ç—ã–π JSON
                    show(res.title, res.info, res.reason);

                } catch (e) {
                    alert("–û—à–∏–±–∫–∞: " + e.message + "\n(–ü—Ä–æ–≤–µ—Ä—å VPN: –°–®–ê/–ù–∏–¥–µ—Ä–ª–∞–Ω–¥—ã)");
                } finally {
                    btn.innerText = oldTxt;
                }
            }
        }

        function show(t, i, r) {
            document.getElementById('resTitle').innerText = t;
            document.getElementById('resInfo').innerText = i;
            document.getElementById('resReason').innerText = r;
            document.getElementById('overlay').style.display = 'block';
            document.getElementById('popup').style.display = 'block';
        }
        function closePopup() {
            document.getElementById('overlay').style.display = 'none';
            document.getElementById('popup').style.display = 'none';
        }
    </script>
</body>
</html>
