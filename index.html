<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>–ö–ò–ù–û –°–∫–∏–ª–ª DeepSeek</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        :root { --bg: #0f1014; --card: #1e1e24; --btn: #2b2b30; --accent: #bb86fc; --ai: #03dac6; --text: #fff; --dim: #9aa0a6; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); padding: 20px; padding-bottom: 160px; margin: 0; }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .logo { font-size: 1.5rem; font-weight: 800; letter-spacing: 1px; }

        .switch { display: flex; background: #222; border-radius: 12px; padding: 4px; margin-bottom: 20px; border: 1px solid #333; }
        .sw-btn { flex: 1; padding: 12px; text-align: center; border-radius: 10px; font-weight: 600; color: #666; transition: 0.3s; cursor: pointer; }
        .sw-btn.active { color: #000; background: #fff; }
        .sw-btn.ai-active { background: var(--ai); color: #000; box-shadow: 0 0 15px rgba(3,218,198,0.3); }

        .title { font-size: 0.7rem; color: var(--dim); text-transform: uppercase; margin: 25px 0 10px 5px; font-weight: 600; letter-spacing: 1px; }
        
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; }
        .btn { background: var(--btn); border: 1px solid transparent; color: var(--text); padding: 14px; border-radius: 16px; font-size: 0.85rem; text-align: center; min-height: 48px; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .btn.active { border-color: #fff; background: #383840; color: #fff; }
        .wide { grid-column: span 2; }

        .main-btn { position: fixed; bottom: 40px; left: 20px; right: 20px; background: #fff; color: #000; border: none; padding: 20px; border-radius: 24px; font-weight: 800; font-size: 1.1rem; z-index: 100; box-shadow: 0 10px 40px rgba(0,0,0,0.5); text-transform: uppercase; cursor: pointer; }
        .ai-btn { background: linear-gradient(135deg, #03dac6, #018786) !important; color: #000 !important; }

        input[type="file"] { margin-bottom: 15px; color: var(--dim); font-size: 0.8rem; width: 100%; }
        
        #popup { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 85%; background: var(--card); padding: 30px; border-radius: 30px; z-index: 1000; border: 1px solid #333; text-align: center; box-shadow: 0 50px 100px rgba(0,0,0,0.9); }
        .ovl { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 999; backdrop-filter: blur(5px); }
        
        .loader { display: inline-block; width: 15px; height: 15px; border: 3px solid rgba(0,0,0,0.2); border-top-color: #000; border-radius: 50%; animation: spin 1s infinite; margin-right: 10px; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div class="header">
        <div class="logo">–ö–ò–ù–û –°–∫–∏–ª–ª</div>
        <div style="font-size: 0.7rem; color: var(--dim);" id="status">–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª</div>
    </div>

    <div class="switch">
        <div id="btnLocal" class="sw-btn active" onclick="setMode('local')">üìÇ –ú–æ–∏</div>
        <div id="btnAI" class="sw-btn" onclick="setMode('ai')">‚ú® –ò–ò</div>
    </div>

    <input type="file" id="fileInput" accept=".xlsx, .xls, .csv">

    <div class="title">–¢–∏–ø</div>
    <div class="grid" data-g="type">
        <button class="btn" onclick="sel(this, ['FILM', '–§–∏–ª—å–º'])">üé¨ –§–∏–ª—å–º</button>
        <button class="btn" onclick="sel(this, ['TV_SERIES', '–°–µ—Ä–∏–∞–ª'])">üì∫ –°–µ—Ä–∏–∞–ª</button>
    </div>

    <div class="title">–ö–æ–Ω—Ç–µ–∫—Å—Ç</div>
    <div class="grid" data-g="context">
        <button class="btn" onclick="sel(this, '–í–µ—á–µ—Ä')">üåÜ –í–µ—á–µ—Ä</button>
        <button class="btn" onclick="sel(this, '–§–æ–Ω')">üéß –§–æ–Ω</button>
        <button class="btn wide" onclick="sel(this, '–í–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ')">üëÄ –í–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ</button>
    </div>

    <div class="title">–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ</div>
    <div class="grid" data-g="mood">
        <button class="btn" onclick="sel(this, '–í–µ—Å—ë–ª–æ–µ')">üòä –í–µ—Å—ë–ª–æ–µ</button>
        <button class="btn" onclick="sel(this, '–ó–∞–¥—É–º—á–∏–≤–æ–µ')">ü§î –î—É–º–∞—Ç—å</button>
        <button class="btn" onclick="sel(this, '–ê–∑–∞—Ä—Ç')">üî• –ê–∑–∞—Ä—Ç</button>
        <button class="btn" onclick="sel(this, '–°–ø–æ–∫–æ–π–Ω–æ–µ')">üòå –†–µ–ª–∞–∫—Å</button>
        <button class="btn" onclick="sel(this, '–ì—Ä—É—Å—Ç–Ω–æ–µ')">üò¢ –ì—Ä—É—Å—Ç—å</button>
    </div>

    <div class="title">–ö–æ–º–ø–∞–Ω–∏—è</div>
    <div class="grid" data-g="company">
        <button class="btn" onclick="sel(this, '–û–¥–∏–Ω')">üßë –û–¥–∏–Ω</button>
        <button class="btn" onclick="sel(this, '–í–¥–≤–æ—ë–º')">üë´ –í–¥–≤–æ—ë–º</button>
        <button class="btn" onclick="sel(this, '–ö–æ–º–ø–∞–Ω–∏—è')">üë• –î—Ä—É–∑—å—è</button>
    </div>

    <div class="title">–ñ–∞–Ω—Ä (–∏–∑ —Ñ–∞–π–ª–∞)</div>
    <div id="genreGrid" class="grid" data-g="genre">
        <div style="font-size:0.8rem; opacity:0.5; padding:10px; grid-column: span 3;">–ñ–∞–Ω—Ä—ã –ø–æ—è–≤—è—Ç—Å—è –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏</div>
    </div>

    <button id="mainBtn" class="main-btn" onclick="go()">–ü–û–î–û–ë–†–ê–¢–¨</button>

    <div class="ovl" id="overlay" onclick="closePopup()"></div>
    <div id="popup">
        <div style="font-size:0.7rem; color:var(--accent); margin-bottom:10px; text-transform:uppercase;">–†–ï–ó–£–õ–¨–¢–ê–¢</div>
        <h2 id="resTitle" style="margin:0 0 10px; font-size:1.5rem; line-height:1.2;"></h2>
        <p id="resInfo" style="color:var(--dim); font-size:0.9rem; margin-bottom:20px;"></p>
        <div id="resReason" style="font-size:0.9rem; background:#2b2b30; padding:15px; border-radius:15px; color:#ddd; text-align:left;"></div>
        <button onclick="closePopup()" style="width:100%; padding:15px; margin-top:20px; border-radius:15px; background:#fff; border:none; font-weight:bold; cursor:pointer;">–ó–ê–ö–†–´–¢–¨</button>
    </div>

    <script>
        // ================================================
        // ‚úÖ –í–°–¢–ê–í–¨ API-–ö–õ–Æ–ß DEEPSEEK –ù–ò–ñ–ï
        const API_KEY = "sk-2b68062a5a8d4ae1bad063ddaced8f7a"; 
        // ================================================

        let mode = 'local';
        let db = [];
        let picks = {};
        let cols = { t: null, g: null, type: null };

        function setMode(m) {
            mode = m;
            document.getElementById('btnLocal').className = `sw-btn ${m==='local'?'active':''}`;
            document.getElementById('btnAI').className = `sw-btn ${m==='ai'?'ai-active':''}`;
            const btn = document.getElementById('mainBtn');
            if(m==='ai') { btn.innerText = "‚ú® –°–ü–†–û–°–ò–¢–¨ DEEPSEEK"; btn.classList.add('ai-btn'); }
            else { btn.innerText = "–ü–û–î–û–ë–†–ê–¢–¨"; btn.classList.remove('ai-btn'); }
        }

        function sel(el, val) {
            const grp = el.parentElement.dataset.g;
            if(el.classList.contains('active')) {
                el.classList.remove('active'); delete picks[grp];
            } else {
                el.parentElement.querySelectorAll('.btn').forEach(b => b.classList.remove('active'));
                el.classList.add('active'); picks[grp] = val;
            }
        }

        document.getElementById('fileInput').addEventListener('change', function(e) {
            const r = new FileReader();
            r.onload = (ev) => {
                try {
                    const d = new Uint8Array(ev.target.result);
                    const wb = XLSX.read(d, {type:'array'});
                    const sName = wb.SheetNames.find(n=>/–±—É–¥—É|watch|–ø–ª–∞–Ω|–∫–∞—Ç–∞–ª–æ–≥/i.test(n)) || wb.SheetNames[0];
                    const sheet = wb.Sheets[sName];
                    const raw = XLSX.utils.sheet_to_json(sheet, {header:1});
                    let skip = 0;
                    for(let i=0; i<Math.min(raw.length,30); i++) {
                        const rowStr = JSON.stringify(raw[i]).toLowerCase();
                        if(rowStr.includes('–Ω–∞–∑–≤–∞–Ω–∏–µ') || rowStr.includes('title')) { skip=i; break; }
                    }
                    const json = XLSX.utils.sheet_to_json(sheet, {range:skip});
                    if(!json.length) return alert('–§–∞–π–ª –ø—É—Å—Ç');
                    
                    const k = Object.keys(json[0]);
                    cols.t = k.find(x=>/–Ω–∞–∑–≤–∞–Ω–∏–µ|title/i.test(x)) || k[0];
                    cols.g = k.find(x=>/–∂–∞–Ω—Ä|genre/i.test(x));
                    cols.type = k.find(x=>/—Ç–∏–ø|type/i.test(x));
                    
                    db = json;
                    drawGenres();
                    document.getElementById('status').innerText = `‚úÖ –§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω (${db.length})`;
                } catch(e) { alert('–û—à–∏–±–∫–∞: '+e.message); }
            };
            r.readAsArrayBuffer(e.target.files[0]);
        });

        function drawGenres() {
            if(!cols.g) return;
            const set = new Set();
            db.forEach(r => {
                if(r[cols.g]) r[cols.g].toString().split(/,|;|\//).forEach(s => set.add(s.trim()));
            });
            const box = document.getElementById('genreGrid');
            box.innerHTML = '';
            [...set].sort().forEach(g => {
                const b = document.createElement('button');
                b.className = 'btn'; b.innerText = g;
                b.onclick = () => sel(b, g); box.appendChild(b);
            });
        }

        async function go() {
            try {
                if(mode === 'local') runLocal();
                else await runAI();
            } catch(e) { alert(e.message); }
        }

        function runLocal() {
            if(!db.length) return alert('–ó–∞–≥—Ä—É–∑–∏—Ç–µ Excel —Ñ–∞–π–ª!');
            let pool = db.filter(m => {
                if(picks.type && m[cols.type]) {
                    if(!picks.type.some(t => m[cols.type].toUpperCase().includes(t.toUpperCase()))) return false;
                }
                if(picks.genre && m[cols.g]) {
                    if(!m[cols.g].toLowerCase().includes(picks.genre.toLowerCase())) return false;
                }
                return true;
            });
            if(!pool.length) pool = db;
            const m = pool[Math.floor(Math.random()*pool.length)];
            show(m[cols.t], m[cols.g], picks.mood ? `–ü–æ–¥ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ: ${picks.mood}` : "–°–ª—É—á–∞–π–Ω—ã–π –≤—ã–±–æ—Ä –∏–∑ —Å–ø–∏—Å–∫–∞.");
        }

        async function runAI() {
            if(API_KEY.includes('–í–°–¢–ê–í–¨')) return alert('–ù—É–∂–Ω–æ –≤—Å—Ç–∞–≤–∏—Ç—å API-–∫–ª—é—á DeepSeek –≤ –∫–æ–¥!');
            
            const btn = document.getElementById('mainBtn');
            const old = btn.innerText;
            btn.innerHTML = '<div class="loader"></div> DEEPSEEK –î–£–ú–ê–ï–¢...';
            
            const seen = db.sort(()=>0.5-Math.random()).slice(0,12).map(m=>m[cols.t]).join(', ');
            
            const prompt = `–¢—ã ‚Äî –∫–∏–Ω–æ-—ç–∫—Å–ø–µ—Ä—Ç. –ü–æ—Å–æ–≤–µ—Ç—É–π 1 —Ñ–∏–ª—å–º/—Å–µ—Ä–∏–∞–ª. 
            –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ: ${picks.mood || '–ª—é–±–æ–µ'}. –ö–æ–º–ø–∞–Ω–∏—è: ${picks.company || '–ª—é–±–∞—è'}. 
            –ö–æ–Ω—Ç–µ–∫—Å—Ç: ${picks.context || '–æ–±—ã—á–Ω—ã–π'}. –¢–∏–ø: ${picks.type ? picks.type[1] : '–ª—é–±–æ–π'}. 
            –ñ–∞–Ω—Ä: ${picks.genre || '–ª—é–±–æ–π'}. –ò—Å–∫–ª—é—á–∏: ${seen}. 
            –í–µ—Ä–Ω–∏ –æ—Ç–≤–µ—Ç –¢–û–õ–¨–ö–û –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON: {"title":"–ù–∞–∑–≤–∞–Ω–∏–µ","info":"–ì–æ–¥, –ñ–∞–Ω—Ä","reason":"–ü–æ—á–µ–º—É –ø–æ–¥—Ö–æ–¥–∏—Ç"}`;

            try {
                const req = await fetch("https://api.deepseek.com/v1/chat/completions", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${API_KEY}` },
                    body: JSON.stringify({
                        model: "deepseek-chat",
                        messages: [{role: "user", content: prompt}],
                        response_format: { type: 'json_object' }
                    })
                });

                if(!req.ok) throw new Error(`–û—à–∏–±–∫–∞ API: ${req.status}`);
                const ans = await req.json();
                const json = JSON.parse(ans.choices[0].message.content);
                show(json.title, json.info, json.reason);
            } catch(e) {
                alert("–û—à–∏–±–∫–∞ –ò–ò: " + e.message);
            } finally {
                btn.innerText = old;
            }
        }

        function show(t, i, r) {
            document.getElementById('resTitle').innerText = t||"";
            document.getElementById('resInfo').innerText = i||"";
            document.getElementById('resReason').innerText = r||"";
            document.getElementById('overlay').style.display = 'block';
            document.getElementById('popup').style.display = 'block';
        }
        function closePopup() {
            document.getElementById('overlay').style.display = 'none';
            document.getElementById('popup').style.display = 'none';
        }
    </script>
</body>
</html>
