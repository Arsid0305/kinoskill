<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>–ö–ò–ù–û –°–∫–∏–ª–ª AI</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        :root { --bg: #0f1014; --card-bg: #1c1d22; --btn-bg: #26282f; --accent: #bb86fc; --ai: #03dac6; --text: #fff; --dim: #8e8e93; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); padding: 20px; padding-bottom: 140px; margin: 0; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .logo { font-size: 1.5rem; font-weight: bold; }
        
        /* –ü–ï–†–ï–ö–õ–Æ–ß–ê–¢–ï–õ–¨ */
        .mode-switch { display: flex; background: #222; border-radius: 12px; padding: 4px; margin-bottom: 20px; }
        .mode-btn { flex: 1; padding: 12px; text-align: center; border-radius: 10px; font-weight: bold; color: #777; cursor: pointer; transition: 0.2s; }
        .mode-btn.active { color: #000; background: #fff; }
        .mode-btn.ai-active { background: var(--ai); color: #000; box-shadow: 0 0 15px rgba(3,218,198,0.4); }

        .section-title { font-size: 0.75rem; color: var(--dim); text-transform: uppercase; margin: 20px 0 10px 5px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; }
        .btn { background: var(--btn-bg); border: 1px solid transparent; color: var(--text); padding: 14px; border-radius: 16px; font-size: 0.85rem; cursor: pointer; transition: 0.2s; }
        .btn.active { border-color: #fff; background: #333; }
        
        .main-btn { position: fixed; bottom: 40px; left: 20px; right: 20px; background: #fff; color: #000; border: none; padding: 20px; border-radius: 22px; font-weight: bold; font-size: 1.1rem; z-index: 100; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .ai-btn { background: linear-gradient(135deg, #03dac6, #00bfa5) !important; color: #000 !important; }

        input[type="file"] { margin-bottom: 15px; color: var(--dim); font-size: 0.8rem; }
        
        /* POPUP */
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 998; }
        #popup { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 85%; background: var(--card-bg); padding: 30px; border-radius: 30px; z-index: 999; text-align: center; border: 1px solid #333; }
        .loader { display: inline-block; width: 15px; height: 15px; border: 3px solid rgba(0,0,0,0.2); border-top-color: #000; border-radius: 50%; animation: spin 1s infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div class="header">
        <div class="logo">–ö–ò–ù–û</div>
        <div style="font-size: 0.7rem; color: var(--dim);" id="status">–ù–µ—Ç —Ñ–∞–π–ª–∞</div>
    </div>

    <div class="mode-switch">
        <div id="mLocal" class="mode-btn active" onclick="setMode('local')">üìÇ –ú–æ–∏</div>
        <div id="mAI" class="mode-btn" onclick="setMode('ai')">‚ú® –ò–ò</div>
    </div>

    <input type="file" id="fileInput" accept=".xlsx, .xls, .csv">

    <div class="section-title">–¢–∏–ø</div>
    <div class="grid" data-g="type">
        <button class="btn" onclick="sel(this, ['FILM', '–§–∏–ª—å–º'])">üé¨ –§–∏–ª—å–º</button>
        <button class="btn" onclick="sel(this, ['TV_SERIES', '–°–µ—Ä–∏–∞–ª'])">üì∫ –°–µ—Ä–∏–∞–ª</button>
    </div>

    <div class="section-title">–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ</div>
    <div class="grid" data-g="mood">
        <button class="btn" onclick="sel(this, '–í–µ—Å—ë–ª–æ–µ')">üòä –í–µ—Å—ë–ª–æ–µ</button>
        <button class="btn" onclick="sel(this, '–ó–∞–¥—É–º—á–∏–≤–æ–µ')">ü§î –î—É–º–∞—Ç—å</button>
        <button class="btn" onclick="sel(this, '–ê–∑–∞—Ä—Ç')">üî• –ê–∑–∞—Ä—Ç</button>
        <button class="btn" onclick="sel(this, '–°–ø–æ–∫–æ–π–Ω–æ–µ')">üòå –†–µ–ª–∞–∫—Å</button>
        <button class="btn" onclick="sel(this, '–ì—Ä—É—Å—Ç–Ω–æ–µ')">üò¢ –ì—Ä—É—Å—Ç—å</button>
    </div>

    <div class="section-title">–ö–æ–º–ø–∞–Ω–∏—è</div>
    <div class="grid" data-g="company">
        <button class="btn" onclick="sel(this, '–û–¥–∏–Ω')">üßë –û–¥–∏–Ω</button>
        <button class="btn" onclick="sel(this, '–í–¥–≤–æ—ë–º')">üë´ –í–¥–≤–æ—ë–º</button>
        <button class="btn" onclick="sel(this, '–ö–æ–º–ø–∞–Ω–∏—è')">üë• –ì—Ä—É–ø–ø–∞</button>
    </div>

    <div class="section-title">–ñ–∞–Ω—Ä (–∏–∑ —Ñ–∞–π–ª–∞)</div>
    <div id="genreBox" class="grid" data-g="genre" style="min-height: 50px;">
        <div style="font-size:0.8rem; opacity:0.5; padding:5px;">–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª...</div>
    </div>

    <button id="mainBtn" class="main-btn" onclick="run()">–ü–û–î–û–ë–†–ê–¢–¨</button>

    <div class="overlay" id="ovl" onclick="closeP()"></div>
    <div id="popup">
        <h2 id="pTitle" style="margin:0 0 10px; font-size:1.4rem;"></h2>
        <p id="pInfo" style="color:var(--dim); font-size:0.9rem;"></p>
        <div id="pReason" style="background:#252525; padding:15px; border-radius:15px; margin-top:15px; font-size:0.9rem; color:#ddd;"></div>
        <button onclick="closeP()" style="width:100%; padding:15px; margin-top:20px; border-radius:15px; border:none; background:#fff; font-weight:bold;">–ó–ê–ö–†–´–¢–¨</button>
    </div>

    <script>
        // ==========================================
        // üëá –í–°–¢–ê–í–¨ –ö–õ–Æ–ß –ù–ò–ñ–ï, –ù–ï –£–î–ê–õ–Ø–Ø –ö–ê–í–´–ß–ö–ò üëá
        const API_KEY = "AIzaSyBhx6GQ06zolekt13hLNYAH7DkDZsv4yBo"; 
        // ==========================================

        let mode = 'local';
        let db = [];
        let picks = {};
        let map = { t: null, g: null, type: null };

        function setMode(m) {
            mode = m;
            document.getElementById('mLocal').className = `mode-btn ${m==='local'?'active':''}`;
            document.getElementById('mAI').className = `mode-btn ${m==='ai'?'ai-active':''}`;
            const btn = document.getElementById('mainBtn');
            if(m==='ai') { btn.innerText = "‚ú® –°–ü–†–û–°–ò–¢–¨ –ò–ò"; btn.classList.add('ai-btn'); }
            else { btn.innerText = "–ü–û–î–û–ë–†–ê–¢–¨"; btn.classList.remove('ai-btn'); }
        }

        function sel(el, val) {
            const grp = el.parentElement.dataset.g;
            if(el.classList.contains('active')) {
                el.classList.remove('active'); delete picks[grp];
            } else {
                el.parentElement.querySelectorAll('.btn').forEach(b=>b.classList.remove('active'));
                el.classList.add('active'); picks[grp] = val;
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const r = new FileReader();
            r.onload = (ev) => {
                try {
                    const d = new Uint8Array(ev.target.result);
                    const wb = XLSX.read(d, {type:'array'});
                    const sName = wb.SheetNames.find(n=>/–±—É–¥—É|watch|–ø–ª–∞–Ω/i.test(n)) || wb.SheetNames[0];
                    const sheet = wb.Sheets[sName];
                    const raw = XLSX.utils.sheet_to_json(sheet, {header:1});
                    let skip = 0;
                    for(let i=0; i<Math.min(raw.length,30); i++) {
                        if(JSON.stringify(raw[i]).toLowerCase().includes('–Ω–∞–∑–≤–∞–Ω–∏–µ')) { skip=i; break; }
                    }
                    const json = XLSX.utils.sheet_to_json(sheet, {range:skip});
                    if(!json.length) return alert('–§–∞–π–ª –ø—É—Å—Ç');
                    
                    const k = Object.keys(json[0]);
                    map.t = k.find(x=>/–Ω–∞–∑–≤–∞–Ω–∏–µ|title/i.test(x)) || k[0];
                    map.g = k.find(x=>/–∂–∞–Ω—Ä|genre/i.test(x));
                    map.type = k.find(x=>/—Ç–∏–ø|type/i.test(x));
                    
                    db = json;
                    drawGenres();
                    document.getElementById('status').innerText = `‚úÖ ${db.length} —Ñ–∏–ª—å–º–æ–≤`;
                } catch(e) { alert('–û—à–∏–±–∫–∞ —Ñ–∞–π–ª–∞: '+e.message); }
            };
            r.readAsArrayBuffer(e.target.files[0]);
        });

        function drawGenres() {
            if(!map.g) return;
            const set = new Set();
            db.forEach(r => {
                if(r[map.g]) r[map.g].toString().split(/,|;|\//).forEach(s => set.add(s.trim()));
            });
            const box = document.getElementById('genreBox');
            box.innerHTML = '';
            [...set].sort().forEach(g => {
                const b = document.createElement('button');
                b.className = 'btn'; b.innerText = g;
                b.onclick = () => sel(b, g);
                box.appendChild(b);
            });
        }

        async function run() {
            if(mode === 'local') {
                if(!db.length) return alert('–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏ —Ñ–∞–π–ª!');
                
                let pool = db.filter(m => {
                    if(picks.type && m[map.type]) {
                        if(!picks.type.some(t => m[map.type].toUpperCase().includes(t.toUpperCase()))) return false;
                    }
                    if(picks.genre && m[map.g]) {
                        if(!m[map.g].toLowerCase().includes(picks.genre.toLowerCase())) return false;
                    }
                    return true;
                });
                
                if(!pool.length) pool = db; // –ï—Å–ª–∏ –ø—É—Å—Ç–æ, –±–µ—Ä–µ–º –≤—Å–µ
                const res = pool[Math.floor(Math.random()*pool.length)];
                
                show(res[map.t], res[map.g], "–°–ª—É—á–∞–π–Ω—ã–π –≤—ã–±–æ—Ä –∏–∑ —Ç–≤–æ–µ–≥–æ —Å–ø–∏—Å–∫–∞.");
            } else {
                // –ò–ò –†–ï–ñ–ò–ú
                if(API_KEY.includes('–í–°–¢–ê–í–¨') || API_KEY.length < 10) return alert('‚õî –í—Å—Ç–∞–≤—å API –∫–ª—é—á –≤ –∫–æ–¥!');
                
                const btn = document.getElementById('mainBtn');
                const oldTxt = btn.innerText;
                btn.innerHTML = '<div class="loader"></div>';
                
                const sample = db.slice(0,10).map(m=>m[map.t]).join(', ');
                const prompt = `–ü–æ—Å–æ–≤–µ—Ç—É–π —Ñ–∏–ª—å–º. –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ: ${picks.mood||'–ª—é–±–æ–µ'}. –ñ–∞–Ω—Ä: ${picks.genre||'–ª—é–±–æ–π'}. –ò—Å–∫–ª—é—á–∏ —ç—Ç–∏: ${sample}. –û—Ç–≤–µ—Ç JSON: {"title":"–ù–∞–∑–≤–∞–Ω–∏–µ","info":"–ì–æ–¥/–ñ–∞–Ω—Ä","reason":"–ü–æ—á–µ–º—É?"}`;
                
                try {
                    const req = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEY}`, {
                        method: 'POST', headers: {'Content-Type':'application/json'},
                        body: JSON.stringify({contents:[{parts:[{text:prompt}]}]})
                    });
                    if(!req.ok) throw new Error('–û—à–∏–±–∫–∞ ' + req.status + ' (–ù—É–∂–µ–Ω VPN?)');
                    const ans = await req.json();
                    if(!ans.candidates) throw new Error('–ò–ò –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª.');
                    
                    const raw = ans.candidates[0].content.parts[0].text.replace(/```json|```/g,'').trim();
                    const json = JSON.parse(raw);
                    show(json.title, json.info, json.reason);
                } catch(e) {
                    alert('–û—à–∏–±–∫–∞ –ò–ò: ' + e.message);
                } finally {
                    btn.innerText = oldTxt;
                }
            }
        }

        function show(t, i, r) {
            document.getElementById('pTitle').innerText = t || "???";
            document.getElementById('pInfo').innerText = i || "";
            document.getElementById('pReason').innerText = r || "";
            document.getElementById('ovl').style.display = 'block';
            document.getElementById('popup').style.display = 'block';
        }
        function closeP() {
            document.getElementById('ovl').style.display = 'none';
            document.getElementById('popup').style.display = 'none';
        }
    </script>
</body>
</html>
